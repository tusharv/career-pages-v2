name: Bump package.json version

on:
  workflow_dispatch:
    inputs:
      release_type:
        description: "Semver release type"
        required: true
        default: patch
        type: choice
        options:
          - patch
          - minor
          - major
  issues:
    types: [closed]

permissions:
  contents: write

jobs:
  bump-version:
    if: |
      (github.event_name == 'push' && !contains(github.event.head_commit.message, '[skip ci]')) ||
      github.event_name == 'workflow_dispatch' ||
      github.event_name == 'issues'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Configure git user
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "358703+tusharv@users.noreply.github.com"

      - name: Determine release type and branch
        id: semver
        uses: actions/github-script@v7
        with:
          script: |
            const inputType = core.getInput('release_type');
            const eventName = context.eventName;
            let type = inputType || 'patch';
            let branch = (context.payload.repository && context.payload.repository.default_branch) || 'main';

            if (eventName === 'issues') {
              const labels = (context.payload.issue.labels || []).map(l => (typeof l === 'string' ? l : l.name).toLowerCase());
              if (labels.some(l => l.includes('breaking-change') || l === 'major')) type = 'major';
              else if (labels.some(l => l.includes('enhancement') || l.includes('feat'))) type = 'minor';
              else if (labels.some(l => l.includes('bug') || l.includes('chore'))) type = 'patch';
              else type = 'patch';
            }

            core.setOutput('type', type);
            core.setOutput('branch', branch);

      - name: Bump version in package.json
        env:
          TYPE: ${{ steps.semver.outputs.type }}
        run: |
          npm ci
          npm version "$TYPE" -m "chore(release): %s [skip ci]"

      - name: Push commit and tags
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          CURRENT_BRANCH="${GITHUB_REF_NAME:-$(git rev-parse --abbrev-ref HEAD)}"
          if [ "${{ github.event_name }}" = "issues" ]; then
            CURRENT_BRANCH="${{ steps.semver.outputs.branch }}"
            git checkout "$CURRENT_BRANCH"
          fi
          git push origin "$CURRENT_BRANCH"
          git push origin --tags


